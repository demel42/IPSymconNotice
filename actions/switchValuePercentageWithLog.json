{
  "id": "{18570FA1-C2D3-DB2F-5200-8485D2B552C6}",
  "caption": "Switch to Value with log",
  "form": [
    "$noticeBases = IPS_GetInstanceListByModuleID('{4CF21C1E-B0F8-5535-8B5D-01ADDDB5DFD7}');",
    "return [",
    "   [",
    "       'type' => 'NumberSpinner',",
    "       'name' => 'PERCENT_VALUE',",
    "       'caption' => 'Value',",
    "       'suffix' => '%',",
    "   ],",
    "   [",
    "       'type' => 'SelectInstance',",
    "       'validModules' => ['{4CF21C1E-B0F8-5535-8B5D-01ADDDB5DFD7}'],",
    "       'name' => 'NOTICE_BASE',",
    "       'value' => isset($noticeBases[0]) ? $noticeBases[0] : 0,",
    "       'caption' => 'Notice base',",
    "   ],",
    "   [",
    "       'type' => 'ValidationTextBox',",
    "       'name' => 'SUCCEED_LOG',",
    "       'width' => '80%',",
    "       'value' => '{NAME} ({LOCATION1}) set to {VALUE}',",
    "       'caption' => 'Log in case of success',",
    "   ],",
    "   [",
    "       'type' => 'ValidationTextBox',",
    "       'name' => 'FAILURE_LOG',",
    "       'width' => '80%',",
    "       'value' => 'Failure: unable to set {NAME} ({LOCATION1}) to {VALUE}',",
    "       'caption' => 'Log in case of failure',",
    "   ]",
    "];"
  ],
  "action": [
    "$variable = IPS_GetVariable($_IPS['TARGET']);",
    "$profileName = $variable['VariableCustomProfile'];",
    "if ($profileName == '') {",
    "   $profileName = $variable['VariableProfile'];",
    "}",
    "$value = $_IPS['PERCENT_VALUE'];",
    "if ($profileName != '') {",
    "   $profile = IPS_GetVariableProfile($profileName);",
    "   $value = ($_IPS['PERCENT_VALUE'] * 0.01 * ($profile['MaxValue'] - $profile['MinValue'])) + $profile['MinValue'];",
    "}",
    "$r = RequestAction($_IPS['TARGET'], $value);",
    "$pat = [];",
    "$sub = [];",
    "$pat[] = '/{VALUE}/';",
    "$value = @GetValueFormatted($_IPS['TARGET']);",
    "if ($value == '') {",
    "    $value = GetValue($_IPS['TARGET']);",
    "}",
    "$sub[] = $value;",
    "$pat[] = '/{NAME}/';",
    "$sub[] = IPS_GetName($_IPS['TARGET']);",
    "$pat[] = '/{LOCATION}/';",
    "$sub[] = IPS_GetLocation($_IPS['TARGET']);",
    "$locS = explode(chr(0x5C), IPS_GetLocation($_IPS['TARGET']));",
    "for ($n = 0, $i = count($locS) - 1; $i >= 0; $n++, $i--) {",
    "    $pat[] = '/{LOCATION' . $n . '}/';",
    "    $sub[] = $locS[$i];",
    "}",
    "$msg = $_IPS[$r ? 'SUCCEED_LOG' : 'FAILURE_LOG'];",
    "$msg = preg_replace($pat, $sub, $msg);",
	"if (IPS_InstanceExists($_IPS['NOTICE_BASE'])) {",
    "    Notice_Log($_IPS['NOTICE_BASE'], $msg, $r ? 'info' : 'warn', []);",
    "} else {",
	"    IPS_LogMessage($_IPS['SELF'], $msg);",
    "}"
  ],
  "restrictions": {
    "objectType": [
      2
    ],
    "variableType": [
      1,
      2
    ],
    "profileIsPercentage": true,
    "requestAction": true
  },
  "priority": 10,
  "locale": {
    "de": {
      "Switch to Value with log": "Schalte auf Wert mit Protokoll",
      "Value": "Wert",
      "Switch to {PERCENT_VALUE} %": "Schalte auf {PERCENT_VALUE} %",
      "Switch the target variable to the defined value with log": "Schalte die Zielvariable auf den definierten Wert mit Protokoll",
      "Notice base": "Mitteilungs-Basis",
      "Log in case of success": "Log im Erfolgsfall",
      "Log in case of failure": "Log im Fehlerfall",
      "{NAME} ({LOCATION1}) set to {VALUE}": "{NAME} ({LOCATION1}) wurde auf {VALUE} gesetzt",
      "Failure: unable to set {NAME} ({LOCATION1}) to {VALUE}": "Failure: {NAME} ({LOCATION1}) kann nicht auf {VALUE} gesetzt werden"
    }
  },
  "format": "Switch to {PERCENT_VALUE} %",
  "category": "switch",
  "description": "Switch the target variable to the defined value",
  "readable": [
    "$variable = IPS_GetVariable($_IPS['TARGET']);",
    "$profileName = $variable['VariableCustomProfile'];",
    "if ($profileName == '') {",
    "   $profileName = $variable['VariableProfile'];",
    "}",
    "$value = $_IPS['PERCENT_VALUE'];",
    "if ($profileName != '') {",
    "   $profile = IPS_GetVariableProfile($profileName);",
    "   $value = ($_IPS['PERCENT_VALUE'] * 0.01 * ($profile['MaxValue'] - $profile['MinValue'])) + $profile['MinValue'];",
    "}",
    "echo 'RequestAction(' . $_IPS['TARGET'] . ', ' . $value . ');';"
  ]
}
